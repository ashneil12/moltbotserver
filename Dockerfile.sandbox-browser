FROM debian:bookworm-slim@sha256:98f4b71de414932439ac6ac690d7060df1f27161073c5036a7553723881bffbe

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
  && apt-get install -y --no-install-recommends \
  bash \
  ca-certificates \
  chromium \
  curl \
  fonts-liberation \
  fonts-noto-color-emoji \
  git \
  jq \
  procps \
  python3 \
  socat \
  websockify \
  x11vnc \
  xvfb \
  && rm -rf /var/lib/apt/lists/*

# Debian's Chromium package ships /etc/chromium.d/default-flags which injects
# --enable-gpu-rasterization unconditionally. Under Xvfb (no real GPU) this
# spawns a --type=gpu-process child that can spin at 100% CPU indefinitely.
# Remove just that line; keep all other system flags intact.
RUN sed -i '/--enable-gpu-rasterization/d' /etc/chromium.d/default-flags

# Install noVNC from GitHub (Debian package is outdated and has broken assets)
ARG NOVNC_VERSION=1.5.0
RUN curl -fsSL "https://github.com/novnc/noVNC/archive/refs/tags/v${NOVNC_VERSION}.tar.gz" \
  | tar -xz -C /opt \
  && mv /opt/noVNC-${NOVNC_VERSION} /opt/novnc \
  && ln -s /opt/novnc/vnc.html /opt/novnc/index.html

COPY scripts/sandbox-browser-entrypoint.sh /usr/local/bin/openclaw-sandbox-browser
COPY scripts/cdp-host-proxy.py /usr/local/bin/openclaw-cdp-host-proxy
RUN chmod +x /usr/local/bin/openclaw-sandbox-browser

RUN useradd --create-home --shell /bin/bash sandbox
USER sandbox
WORKDIR /home/sandbox

EXPOSE 9222 5900 6080

CMD ["openclaw-sandbox-browser"]
