# OPENCLAW_CONTEXT.md — Upstream Sync Reference

Quick reference for preserving MoltBot customizations when merging from `upstream/main`.
For full change history and rationale, see `OPENCLAW_CHANGELOG.md`.
For files with critical local patches that Node.js `fetch()` workarounds, see `LOCAL_PATCHES.md`.

---

## Fully Custom Files (safe from upstream — no merge conflicts)

These files don't exist in upstream. They will never conflict but must not be deleted during sync.

| File / Directory                                   | Feature                                                                                                                                                                                                                                                                                                                                                                                    |
| -------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `docker-entrypoint.sh`                             | Managed platform guards, Sansa provider, memory template seeding, `allowlist`→`groupAllowFrom` migration, `groupPolicy` validation, stock plugin discovery fix, Honcho plugin pre-bake copy + runtime install fallback (`HONCHO_API_KEY`), extensions re-chown to `root:root` after global chown, device pairing auto-approve (backgrounded), runs as root (no `gosu node` privilege drop) |
| `enforce-config.mjs`                               | Model normalization, reflection intervals, cron job seeding (with `MAIN_ONLY_JOBS` filtering for sub-agents), tool loop detection enablement, per-agent browser profile enforcement (`enforceBrowserProfiles()`), per-agent browser container provisioning (`ensureAgentBrowserContainers()`)                                                                                              |
| `cron/default-jobs.json`                           | Default cron job definitions                                                                                                                                                                                                                                                                                                                                                               |
| `src/gateway/sandbox-browsers.ts`                  | Sandbox browser API + noVNC HTTP/WS proxy + per-agent static browser discovery from `config.browser.profiles` + `isSensitiveBrowserPath()` auth gating (only `vnc.html`/`websockify` require auth, static assets pass through)                                                                                                                                                             |
| `src/cron/pre-reset-flush.ts`                      | Pre-reset memory flush cron                                                                                                                                                                                                                                                                                                                                                                |
| `src/cron/pre-reset-flush.test.ts`                 | Tests for above                                                                                                                                                                                                                                                                                                                                                                            |
| `src/agents/models-config.providers.sansa.test.ts` | Sansa provider tests                                                                                                                                                                                                                                                                                                                                                                       |
| `src/browser/chrome.test.ts`                       | Proxy support unit tests                                                                                                                                                                                                                                                                                                                                                                   |
| `src/commands/onboard-interactive.e2e.test.ts`     | Onboarding E2E test                                                                                                                                                                                                                                                                                                                                                                        |
| `scripts/sandbox-browser-entrypoint.sh`            | Custom browser container entrypoint — includes `OPENCLAW_BROWSER_NOVNC_NO_AUTH` env var, CDP host proxy integration (replaces socat)                                                                                                                                                                                                                                                       |
| `scripts/cdp-host-proxy.py`                        | Python HTTP+WebSocket reverse proxy for CDP — rewrites Host header to `localhost` for Chromium 107+ compatibility with Docker hostnames                                                                                                                                                                                                                                                    |
| `Dockerfile.sandbox-browser`                       | Browser container Dockerfile — includes `COPY` for `cdp-host-proxy.py`                                                                                                                                                                                                                                                                                                                     |
| `LOCAL_PATCHES.md`                                 | Documents files with critical local patches that must survive upstream syncs, with quick verification commands                                                                                                                                                                                                                                                                             |
| `skills/add-agent/SKILL.md`                        | Agent creation skill                                                                                                                                                                                                                                                                                                                                                                       |
| `docs/reference/templates/howtobehuman.md`         | Human voice philosophy template                                                                                                                                                                                                                                                                                                                                                            |
| `docs/reference/templates/writelikeahuman.md`      | Human voice writing patterns template                                                                                                                                                                                                                                                                                                                                                      |
| `docs/reference/templates/memory/*`                | Memory file templates                                                                                                                                                                                                                                                                                                                                                                      |
| `docs/reference/templates/MEMORY.md`               | Top-level MEMORY.md template (10 sections: Standing Instructions, Environment, People, Projects, Key Decisions, Workflows, Preferences, Reflections, Notes, Things to Revisit)                                                                                                                                                                                                             |
| `src/memory/knowledge-index.ts`                    | Knowledge base auto-index builder — scans `memory/knowledge/*.md`, extracts summaries, writes `_index.md`                                                                                                                                                                                                                                                                                  |
| `src/memory/knowledge-index.test.ts`               | Tests for knowledge-index builder                                                                                                                                                                                                                                                                                                                                                          |
| `src/security/content-scanner.ts`                  | Two-stage content scanner (regex patterns + optional frontier model). Risk scoring via `sqrt(sum) * 15`.                                                                                                                                                                                                                                                                                   |
| `src/security/content-scanner.test.ts`             | Tests for content scanner (48 tests)                                                                                                                                                                                                                                                                                                                                                       |
| `src/security/data-classification.ts`              | Three-tier data classification (Confidential/Internal/Public) with PII detection                                                                                                                                                                                                                                                                                                           |
| `src/security/data-classification.test.ts`         | Tests for data classification (47 tests)                                                                                                                                                                                                                                                                                                                                                   |
| `src/security/scan-and-log.ts`                     | Shared `scanAndLog()` helper — DRY wrapper for scan + event log + warn. Lazy singleton EventLogger.                                                                                                                                                                                                                                                                                        |
| `src/logging/event-log.ts`                         | Structured JSONL event logger with PII redaction, log rotation, queryable history                                                                                                                                                                                                                                                                                                          |
| `src/logging/event-log.test.ts`                    | Tests for event logger (30 tests)                                                                                                                                                                                                                                                                                                                                                          |
| `src/logging/diagnostics-toolkit.ts`               | System health checks: PID file, port reachability, error rate, disk space                                                                                                                                                                                                                                                                                                                  |
| `src/logging/diagnostics-toolkit.test.ts`          | Tests for diagnostics toolkit (21 tests)                                                                                                                                                                                                                                                                                                                                                   |
| `src/cron/service/timer.next-wake.test.ts`         | Tests for `parseNextWakeDuration` (dynamic `NEXT_WAKE:` scheduling)                                                                                                                                                                                                                                                                                                                        |

---

## Files With Custom Modifications (check on every sync)

These exist in upstream AND have local changes. Conflicts are likely.

### Source Files

| File                                      | What to preserve                                                                                                                                                                                                                                                                                                          |
| ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `src/gateway/server-methods/update.ts`    | `OPENCLAW_MANAGED_PLATFORM` guard at top of `update.run`                                                                                                                                                                                                                                                                  |
| `src/cli/update-cli/update-command.ts`    | `OPENCLAW_MANAGED_PLATFORM` guard at top of `updateCommand()`                                                                                                                                                                                                                                                             |
| `src/infra/update-startup.ts`             | Early return in `runGatewayUpdateCheck()` when managed platform                                                                                                                                                                                                                                                           |
| `src/agents/sandbox/types.ts`             | `"browser-only"` in `SandboxConfig.mode` union                                                                                                                                                                                                                                                                            |
| `src/agents/sandbox/runtime-status.ts`    | `browser-only` treated like `non-main`                                                                                                                                                                                                                                                                                    |
| `src/agents/sandbox/context.ts`           | `browser-only` skips container+workspace                                                                                                                                                                                                                                                                                  |
| `src/agents/sandbox/config.ts`            | Auto-enable browser for `browser-only` mode                                                                                                                                                                                                                                                                               |
| `src/agents/sandbox/browser.ts`           | `docker network connect` + `${containerName}-profile` named volume                                                                                                                                                                                                                                                        |
| `src/config/types.agent-defaults.ts`      | `"browser-only"` in mode type                                                                                                                                                                                                                                                                                             |
| `src/config/types.agents.ts`              | `"browser-only"` in mode type                                                                                                                                                                                                                                                                                             |
| `src/config/zod-schema.agent-runtime.ts`  | `"browser-only"` in Zod schema                                                                                                                                                                                                                                                                                            |
| `src/gateway/control-ui.ts`               | Replaced synchronous `fs.readFileSync` with async `fs.createReadStream()` + pipeline for performance                                                                                                                                                                                                                      |
| `src/gateway/control-ui.test.ts`          | Await added to refactored async route handlers                                                                                                                                                                                                                                                                            |
| `src/gateway/control-ui.http.test.ts`     | Await added to refactored async route handlers                                                                                                                                                                                                                                                                            |
| `src/gateway/gateway-misc.test.ts`        | Await added to refactored async route handlers                                                                                                                                                                                                                                                                            |
| `src/gateway/server-http.ts`              | `handleSandboxBrowserRequest` + `handleSandboxBrowserUpgrade` integration (import + HTTP chain + WS upgrade chain); await added to async Control UI and Avatar requests                                                                                                                                                   |
| `src/agents/openclaw-tools.ts`            | `agentId: resolveSessionAgentId()` added to `createBrowserTool()` call — without this, agents use the main browser instead of their dedicated container                                                                                                                                                                   |
| `src/agents/models-config.providers.ts`   | `buildSansaProvider()` + Sansa constants                                                                                                                                                                                                                                                                                  |
| `src/agents/model-auth.ts`                | `sansa: "SANSA_API_KEY"` in env key map                                                                                                                                                                                                                                                                                   |
| `src/gateway/server-cron.ts`              | `startPreResetFlushTimer` / `stopPreResetFlush` integration                                                                                                                                                                                                                                                               |
| `src/gateway/server-reload-handlers.ts`   | `stopPreResetFlush()` call on cron restart                                                                                                                                                                                                                                                                                |
| `src/config/sessions/types.ts`            | `preResetFlushAt?: number` field on `SessionEntry`                                                                                                                                                                                                                                                                        |
| `src/auto-reply/reply/session.ts`         | `preResetFlushAt = undefined` clear on init/reset                                                                                                                                                                                                                                                                         |
| `src/agents/system-prompt.ts`             | Removed `hasPracticalFile`; `howtobehuman.md`/`writelikeahuman.md` detection; updated voice prompt; stale `IDENTITY.md` health nudge (72h mtime check)                                                                                                                                                                    |
| `src/agents/workspace.ts`                 | `resolveHumanModeEnabled()`, `resolveHonchoEnabled()`, Honcho conditionals, `stripHonchoConditionals()`, `removeHumanModeSectionFromSoul()`; `preLoad` callback on `WorkspaceBootstrapFile` for `rebuildKnowledgeIndex` hook; file content cache with mtime invalidation; `MEMORY.md` seeding in `ensureAgentWorkspace()` |
| `src/cron/service/timer.ts`               | `parseNextWakeDuration()` — parses `NEXT_WAKE: <duration>` directive from agent responses; dynamic schedule override in `applyJobResult`; `nextRunAfterMs` field forwarded through entire outcome chain                                                                                                                   |
| `src/cron/isolated-agent/run.ts`          | External hook content scanned via `scanAndLog()`; cron outcome event logging via shared lazy-imported logger                                                                                                                                                                                                              |
| `src/agents/tools/web-fetch.ts`           | Fetched page content scanned via `scanAndLog()`                                                                                                                                                                                                                                                                           |
| `src/agents/tools/browser-tool.ts`        | Browser snapshots, console output, and tab data scanned via `scanAndLog()`                                                                                                                                                                                                                                                |
| `src/logging/diagnostic.ts`               | Periodic health check (every ~5min via heartbeat counter) using `runHealthCheck` from diagnostics-toolkit                                                                                                                                                                                                                 |
| `src/browser/chrome.ts`                   | `resolveProxyServer()`, `generateProxyAuthExtension()`, proxy args in `launchChrome()`; `fetchChromeVersion` uses `fetchJson` (CDP Host header fix)                                                                                                                                                                       |
| `src/browser/cdp.helpers.ts`              | **⚠️ CDP Host header fix**: `httpRequestWithHostOverride()` function + modified `fetchChecked()` — uses `http.request()` instead of `fetch()` because Node.js `fetch()` silently ignores the `Host` header (forbidden per Fetch spec). Without this, Docker hostnames fail.                                               |
| `src/discord/send.components.ts`          | Removed unused `APIChannel` type import (lint fix)                                                                                                                                                                                                                                                                        |
| `src/agents/tools/recall-message-tool.ts` | Removed redundant type assertion on `source` variable (lint fix)                                                                                                                                                                                                                                                          |

### Template & Doc Files

| File                                     | What to preserve                                                                                                                                                                                                                                                                                                                                                                                    |
| ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `SOUL.md`                                | Complete rewrite (actionable framework, not philosophical essay)                                                                                                                                                                                                                                                                                                                                    |
| `AGENTS.md`                              | No "Read PRACTICAL.md" step; "Multi-Account Channels" section                                                                                                                                                                                                                                                                                                                                       |
| `OPERATIONS.md`                          | Heartbeat step 4 + System Updates section (no self-update); 3-tier reflection system description                                                                                                                                                                                                                                                                                                    |
| `Dockerfile`                             | No `COPY PRACTICAL.md` line; Honcho plugin pre-bake section (lines 70–82): pack + extract + install deps into `/app/prebaked-plugins/openclaw-honcho`                                                                                                                                                                                                                                               |
| `docs/reference/templates/SOUL.md`       | Full rewrite — Ouroboros ontological framing, 3 axes of becoming, Ship of Theseus protection, 7 Biblical principles woven throughout                                                                                                                                                                                                                                                                |
| `docs/reference/templates/AGENTS.md`     | No "Read PRACTICAL.md" step; "Multi-Account Channels" section                                                                                                                                                                                                                                                                                                                                       |
| `docs/reference/templates/HEARTBEAT.md`  | Proactive Presence section (agent-initiated outreach); updated self-reflection cadence                                                                                                                                                                                                                                                                                                              |
| `docs/reference/templates/BOOT.md`       | Startup state verification example (read IDENTITY.md, WORKING.md, open-loops on boot)                                                                                                                                                                                                                                                                                                               |
| `docs/reference/templates/OPERATIONS.md` | 3-tier reflection system (Self-Review/Consciousness Loop/Deep Review) + `NEXT_WAKE:` directive docs                                                                                                                                                                                                                                                                                                 |
| `docs/zh-CN/reference/templates/SOUL.md` | Custom rewrite (sync from EN version when updating)                                                                                                                                                                                                                                                                                                                                                 |
| `cron/default-jobs.json`                 | 3-tier reflection jobs: `self-review` (6h), `consciousness` (2h dynamic via `NEXT_WAKE:`), `deep-review` (48h + Phase 0 constitution check); `nightly-innovation` (2 AM, 5-phase autonomous building + backlog integration); `morning-briefing` (8 AM, personalized daily summary + backlog surfacing); `self-audit-21` (Sun 11 PM, weekly 21-question strategic audit feeding improvement backlog) |

### CI Workflows

| File                                         | What to preserve                                        |
| -------------------------------------------- | ------------------------------------------------------- |
| `.github/workflows/ci.yml`                   | `ubuntu-latest` / `windows-latest` (not `blacksmith-*`) |
| `.github/workflows/docker-release.yml`       | `ubuntu-latest` (not `blacksmith-*`)                    |
| `.github/workflows/install-smoke.yml`        | `ubuntu-latest` (not `blacksmith-*`)                    |
| `.github/workflows/workflow-sanity.yml`      | `ubuntu-latest` (not `blacksmith-*`)                    |
| `.github/workflows/sandbox-common-smoke.yml` | `ubuntu-latest` (not `blacksmith-*`)                    |
| `.github/workflows/labeler.yml`              | `ubuntu-latest` (not `blacksmith-*`)                    |
| `.github/workflows/stale.yml`                | `ubuntu-latest` (not `blacksmith-*`)                    |
| `.github/workflows/auto-response.yml`        | `ubuntu-latest` (not `blacksmith-*`)                    |
| `.github/workflows/docker-build.yml`         | Custom `build-browser` job                              |

---

## Post-Sync Checklist

1. **Blacksmith runners** — `grep -r "blacksmith" .github/workflows/` → replace with `ubuntu-latest` / `windows-latest`
2. **soul-evil** — `rm -rf src/hooks/bundled/soul-evil src/hooks/soul-evil.ts src/hooks/soul-evil.test.ts docs/hooks/soul-evil.md docs/zh-CN/hooks/soul-evil.md` → strip references from docs
3. **PRACTICAL.md** — if re-introduced by upstream, delete it and remove any references
4. **New update vectors** — check for new CLI commands or RPC methods that could trigger self-update; add `OPENCLAW_MANAGED_PLATFORM` guards
5. **noVNC auth** — verify `sandbox-browser-entrypoint.sh` still has `OPENCLAW_BROWSER_NOVNC_NO_AUTH` support (no-auth mode for dashboard browser views)
6. **CDP Host header fix** — **critical**: `grep -c 'httpRequestWithHostOverride' src/browser/cdp.helpers.ts` must return ≥ 1. Without this, `http://browser:9222` fails. See `LOCAL_PATCHES.md`.
7. **Sandbox browser wiring** — `grep -c 'handleSandboxBrowserRequest' src/gateway/server-http.ts` must return ≥ 1. Without this, `/api/sandbox-browsers` returns SPA HTML instead of JSON.
8. **Honcho pre-bake** — `grep -c 'prebaked-plugins' Dockerfile` must return ≥ 1. Without this, the Honcho plugin has wrong ownership and gets rejected by the plugin scanner.
9. **Browser tool agent routing** — **critical**: `grep -c 'agentId.*resolveSessionAgentId' src/agents/openclaw-tools.ts` must return ≥ 1. Without this, agents use the main browser instead of their dedicated containers.
10. **Build verification** — `npm install && npm run build`
